<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <link rel="icon" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20100%20100%22%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2250%25%22%20style%3D%22dominant-baseline%3Acentral%3Btext-anchor%3Amiddle%3Bfont-size%3A90px%3B%22%3E%26%23x1F4D7%3B%3C/text%3E%3C/svg%3E">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>BIB-LIO</title>
    <link rel="stylesheet" type="text/css" href="./almond.lite.css">
    <link rel="stylesheet" type="text/css" href="./additional.css">
</head>

<body>
    <div class="container">
        <div id="app">
            <div class="ui">
                <div class="isbn">
                    <div class="box">
                        <input type="tel" v-model="bookNum" v-select @keydown.enter="getBiblioData">
                        <button class="clear-button" @click="clearBox" tabindex="-1">&times;</button>
                    </div>
                    <button @click="getBiblioData">GO</button>
                </div>
                <div class="preview" v-cloak>{{isbnFullFormat}}</div>
            </div>
            <textarea readonly v-model="info"></textarea>
            <button @click="openScrapBox">SCRAP</button>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.37/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
        const getCheckDigit = (isbn) => {
            const total = String(isbn).split("").map((n, i) => {
                if (i % 2 == 0) {
                    return Number(n);
                }
                return Number(n) * 3;
            }).reduce((accum, x) => {
                return accum + Number(x)
            }, 0);
            return ((10 - (total % 10))) % 10;
        }

        const formatPubdate = (s) => {
            const pd = s.replace(/[^\d]/g, "");
            console.log(pd);
            return pd.substr(0,4) + "/" + pd.substr(4,2) + "/" + pd.substr(6,2);
        }

        const formatIsbn = (s) => {
            return s.substr(0,3) + "-" + s.substr(3,1) + "-" + s.substr(4,8) + "-" + s.substr(12,1);
        }

        const formatContent = (title="", author="", publisher="", pubdate="", detail="") => {
            const lines = [
                `『${title.trim()}』`,
            ];
            if (author.trim().length) {
                lines.push(author.trim());
            }
            else {
                lines.push("／著");
            }
            lines.push(`（${publisher.trim()} ${ formatPubdate(pubdate.trim())}）`);
            if (detail.trim().length) {
                lines.push("\n\n----------（公式情報）----------");
                lines.push(detail.trim());
            }
            return lines.join("\n")
        }

        const vm = Vue.createApp({
            data: function () {
                return {
                    bookNum: "",
                    bookTitle: "",
                    publisher: "",
                    author: "",
                    pubDate: "",
                    detail: "",
                    info: "",
                }
            },
            computed: {
                strNum: function () {
                    return String(this.bookNum).replace(/\s|[^\d]/g, "");
                },
                isbn: function () {
                    if (this.strNum.length == 13) {
                        return this.strNum.substr(0,12);
                    }
                    return `9784${this.strNum.padStart(8, "0")}`;
                },
                checkDigit: function () {
                    return getCheckDigit(this.isbn);
                },
                isbnFull: function () {
                    return `${this.isbn}${this.checkDigit}`;
                },
                isbnFullFormat: function () {
                    return formatIsbn(this.isbnFull);
                },
            },
            methods: {
                clearBox: function () {
                    this.bookNum = "";
                },
                reset: function () {
                    this.info = "";
                },
                getBiblioData: function () {
                    this.reset();
                    axios.get(`https://api.openbd.jp/v1/get?isbn=${this.isbnFull}`).then(response => {
                        if (!response.data[0]) {
                            this.info = formatContent();
                            return;
                        }
                        const summary = response.data[0].summary;
                        const colDeteil = response.data[0].onix.CollateralDetail;
                        const detail = (colDeteil.TextContent)? colDeteil.TextContent.map(tc => tc.Text).join("\n") : "";
                        this.info = formatContent(summary.title, summary.author, summary.publisher, summary.pubdate, detail);
                    });
                },
                openScrapBox: function() {
                    const title = this.isbnFullFormat;
                    const body = this.info;
                    window.open("https://scrapbox.io/arikaebanataw-69882885/" + encodeURIComponent(title) + "?body=" + encodeURIComponent(body));
                },
            },
            directives: {
                select: {
                    mounted: function (el) {
                        el.select()
                    }
                }
            }
        }).mount("#app");
    </script>
</body>

</html>