<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <!-- Chrome / Firefox / Edge -->
    <link rel="icon"
        href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20100%20100%22%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2250%25%22%20style%3D%22dominant-baseline%3Acentral%3Btext-anchor%3Amiddle%3Bfont-size%3A90px%3B%22%3E%F0%9F%93%9A%EF%B8%8F%3C%2Ftext%3E%3C%2Fsvg%3E">
    <!-- Safari / IE -->
    <link rel="icon alternate" type="image/png"
        href="https://cdn.jsdelivr.net/gh/jdecked/twemoji@latest/assets/72x72/1f4da.png" />
    <title>BOOK-SCRAP</title>
    <link rel="stylesheet" type="text/css" href="./milligram.min.css">
    <link rel="stylesheet" type="text/css" href="./additional.css">
</head>

<body>
    <div class="container">
        <div id="app">
            <div class="isbn">
                <div class="preview" v-cloak>{{isbnFormat}}</div>
                <div class="searchBox">
                    <input type="tel" v-model="bookNum" ref="userInput" @keydown.enter="fetchData"
                        @keyup.enter="fetchData">
                    <button class="clear-button" @click="clearBox" tabindex="-1">&times;</button>
                </div>
                <div class="buttonBox">
                    <button @click="fetchData">Go</button>
                    <label><input type="checkbox" v-model="searchOnGoogleBooks">GoogleBooks</label>
                </div>
            </div>
            <details>
                <summary>Configure</summary>
                <button class="button-outline" @click="googleSearch">Google</button>
                <label>Title<input type="text" v-model="title"></label>
                <label>Subtitle<input type="text" v-model="subtitle"></label>
                <label>Publisher<input type="text" v-model="publisherName"></label>
                <label>Publish Year<input type="text" v-model="pubYear"></label>
                <label>Tags (space-separated)<input type="text" v-model="authorInfo"></label>
            </details>
            <div class="front-matter">
                <textarea readonly tabindex="-1" v-model="frontMatter"></textarea>
                <button @click="copyFrontMatter" :class="{done:frontMatterCopied}">Copy</button>
            </div>
            <button @click="copyFileName" :class="{done:fileNameCopied}">Copy FileName</button>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.37/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
        const toHalfWidth = (s) => {
            return s.replace(/[\uff21-\uff3a\uff41-\uff5a\uff10-\uff19]/g, (s) => {
                return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
            });
        }

        const getCheckDigit = (isbn) => {
            const total = String(isbn).split("").map((n, i) => {
                if (i % 2 == 0) {
                    return Number(n);
                }
                return Number(n) * 3;
            }).reduce((accum, x) => {
                return accum + Number(x)
            }, 0);
            return ((10 - (total % 10))) % 10;
        }

        const vm = Vue.createApp({
            data: function () {
                return {
                    bookNum: "",
                    searchOnGoogleBooks: false,
                    title: "",
                    subtitle: "",
                    publisherName: "",
                    pubYear: "",
                    authorInfo: "",
                    frontMatterCopied: false,
                    fileNameCopied: false,
                }
            },
            computed: {
                isbn: function () {
                    const s = ("00000000" + this.bookNum).substring(0, 16);
                    return "9784" + s.substring(s.length - 8, s.length);
                },
                isbnFull: function () {
                    return `${this.isbn}${getCheckDigit(this.isbn)}`;
                },
                isbnFormat: function () {
                    const s = this.isbnFull;
                    return s.substr(0, 3) + "-" + s.substr(3, 1) + "-" + s.substr(4, 8) + "-" + s.substr(12, 1);
                },
                authors: function () {
                    return this.authorInfo.split(" ").map(x => x.split("／")[0]).map(x => "  - " + toHalfWidth(x));
                },
                titleFormatted: function () {
                    return toHalfWidth(this.title);
                },
                fullTitleFormatted: function () {
                    const st = (this.subtitle.length && this.subtitle != this.titleFormatted) ? ("\u2015\u2015" + this.subtitle) : "";
                    return toHalfWidth(this.title + st).replace(/ *: */g, "\uff1a");
                },
                frontMatter: function () {
                    return [
                        "---",
                        "aliases:",
                        "  - " + this.titleFormatted,
                        "  - " + this.fullTitleFormatted,
                        "isbn: " + this.isbnFull,
                        "from: " + toHalfWidth(this.publisherName),
                        "year: " + this.pubYear,
                        "tags:",
                        this.authors.join("\n"),
                        "---",
                        "",
                    ].join("\n");
                }
            },
            methods: {
                clearBox: function () {
                    this.bookNum = "";
                },
                resetInfo: function () {
                    this.title = "";
                    this.subtitle = "";
                    this.publisherName = "";
                    this.pubYear = "";
                    this.authorInfo = "";
                },
                resetCopyStatus: function () {
                    this.frontMatterCopied = false;
                    this.fileNameCopied = false;
                },
                fetchOpenBD: function () {
                    this.resetInfo();
                    this.resetCopyStatus();
                    axios.get(`https://api.openbd.jp/v1/get?isbn=${this.isbnFull}`).then(response => {
                        if (response.data[0]) {
                            const summary = response.data[0].summary;
                            this.title = summary.title;
                            this.subtitle = response.data[0].onix.DescriptiveDetail.TitleDetail.TitleElement.TitleText.content || "";
                            this.publisherName = summary.publisher;
                            this.pubYear = summary.pubdate.substring(0, 4);
                            this.authorInfo = summary.author;
                        }
                    });
                },
                fetchGoogleBooks: function () {
                    this.resetInfo();
                    this.resetCopyStatus();
                    axios.get(`https://www.googleapis.com/books/v1/volumes?q=isbn:${this.isbnFull}`).then(response => {
                        if (response.data.items) {
                            const vInfo = response.data.items[0].volumeInfo;
                            this.title = vInfo.title;
                            this.subtitle = vInfo.subtitle || "";
                            this.publisherName = vInfo.publisher || "";
                            this.pubYear = (vInfo.publishedDate || "").substring(0, 4);
                            this.authorInfo = vInfo.authors.join(" ");
                        }
                    })
                },
                fetchData: function () {
                    if (this.searchOnGoogleBooks) {
                        this.fetchGoogleBooks();
                    }
                    else {
                        this.fetchOpenBD();
                    }
                },
                googleSearch: function () {
                    window.open("https://www.google.com/search?hl=ja&q=" + this.isbnFull);
                },
                copyFrontMatter: function () {
                    navigator.clipboard.writeText(this.frontMatter);
                    this.frontMatterCopied = true;
                },
                copyFileName: function () {
                    navigator.clipboard.writeText(this.isbnFull);
                    this.fileNameCopied = true;
                },
            },
            watch: {
                bookNum: function () {
                    this.resetInfo();
                    this.resetCopyStatus();
                },
                frontMatter: function () {
                    this.resetCopyStatus();
                },
            },
        }).mount("#app");
    </script>
</body>

</html>