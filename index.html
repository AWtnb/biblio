<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <!-- Chrome / Firefox / Edge -->
    <link rel="icon"
        href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20100%20100%22%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2250%25%22%20style%3D%22dominant-baseline%3Acentral%3Btext-anchor%3Amiddle%3Bfont-size%3A90px%3B%22%3E%F0%9F%93%9A%EF%B8%8F%3C%2Ftext%3E%3C%2Fsvg%3E">
    <!-- Safari / IE -->
    <link rel="icon alternate" type="image/png"
        href="https://cdn.jsdelivr.net/gh/jdecked/twemoji@latest/assets/72x72/1f4da.png" />
    <title>BIBLIO-SCRAP</title>
    <link rel="stylesheet" type="text/css" href="./milligram.min.css">
    <link rel="stylesheet" type="text/css" href="./additional.css">
</head>

<body>
    <div class="container">
        <div id="app">
            <div class="ui">
                <div class="isbn">
                    <div class="preview" v-cloak>{{isbnFormat}}</div>
                    <input type="tel" v-model="bookNum" ref="userInput" @keydown.enter="fetchOpenBD"
                        @keyup.enter="fetchOpenBD">
                    <div class="box">
                        <button @click="fetchOpenBD">OpenBD</button>
                        <button @click="fetchGoogleBooks">GoogleBooks</button>
                    </div>
                    <button class="clear-button" @click="clearBox" tabindex="-1">&times;</button>
                </div>
            </div>
            <details>
                <summary>Configure</summary>
                <button @click="googleSearch">Google</button>
                <label>Title<input type="text" v-model="title"></label>
                <label>Subtitle<input type="text" v-model="subtitle"></label>
                <label>Publisher<input type="text" v-model="publisherName"></label>
                <label>Publish Year<input type="text" v-model="pubYear"></label>
                <label>Tags (space-separated)<input type="text" v-model="authorInfo"></label>
            </details>
            <textarea readonly tabindex="-1" v-model="frontMatter"></textarea>
            <button @click="copyFileName">Copy FileName</button>
            <button @click="copyFrontMatter">Copy FrontMatter</button>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.37/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
        const toHalfWidth = (s) => {
            return s.replace(/[\uff21-\uff3a\uff41-\uff5a\uff10-\uff19]/g, (s) => {
                return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
            });
        }

        const getCheckDigit = (isbn) => {
            const total = String(isbn).split("").map((n, i) => {
                if (i % 2 == 0) {
                    return Number(n);
                }
                return Number(n) * 3;
            }).reduce((accum, x) => {
                return accum + Number(x)
            }, 0);
            return ((10 - (total % 10))) % 10;
        }

        const calcISBN = (s) => {
            if (s.length == 9) {
                return `9784${s.substr(0, 8)}`;
            }
            if (s.length == 13) {
                return s.substr(0, 12);
            }
            return `9784${s.padStart(8, "0")}`;
        }

        const formatToc = (s, asSimple = false) => {
            return s.split(/\n+/).map((line, idx) => {
                const title = "「" + line.replace(/「/g, "『").replace(/」/g, "』") + "」";
                if (asSimple) {
                    return title;
                }
                return `第${idx + 1}章${title}`;
            }).join("\n\n\n");
        }

        const vm = Vue.createApp({
            data: function () {
                return {
                    bookNum: "",
                    title: "",
                    subtitle: "",
                    publisherName: "",
                    pubYear: "",
                    authorInfo: "",
                    frontMatterCopied: false,
                    fileNameCopied: false,
                }
            },
            computed: {
                strNum: function () {
                    return String(this.bookNum).replace(/\s|[^\d]/g, "");
                },
                isbn: function () {
                    return calcISBN(this.strNum);
                },
                checkDigit: function () {
                    return getCheckDigit(this.isbn);
                },
                isbnFull: function () {
                    return `${this.isbn}${this.checkDigit}`;
                },
                isbnFormat: function () {
                    const s = this.isbnFull;
                    return s.substr(0, 3) + "-" + s.substr(3, 1) + "-" + s.substr(4, 8) + "-" + s.substr(12, 1);
                },
                authors: function () {
                    return this.authorInfo.split(" ").map(x => x.split("／")[0]).map(x => "  - " + toHalfWidth(x));
                },
                titleFormatted: function () {
                    const st = (this.subtitle.length && this.subtitle != this.title) ? ("\u2015\u2015" + this.subtitle) : "";
                    return toHalfWidth(this.title + st).replace(/ *: */g, "\uff1a");
                },
                frontMatter: function () {
                    return [
                        "---",
                        "aliases:",
                        "  - " + this.title,
                        "  - " + this.titleFormatted,
                        "isbn: " + this.isbnFull,
                        "title: " + toHalfWidth(this.titleFormatted),
                        "from: " + toHalfWidth(this.publisherName),
                        "year: " + this.pubYear,
                        "tags:",
                        this.authors.join("\n"),
                        "---",
                    ].join("\n");
                }
            },
            methods: {
                clearBox: function () {
                    this.bookNum = "";
                },
                reset: function () {
                    this.title = "";
                    this.subtitle = "";
                    this.publisherName = "";
                    this.pubYear = "";
                    this.authorInfo = "";
                    this.frontMatterCopied = false;
                    this.fileNameCopied = false;
                },
                fetchOpenBD: function () {
                    this.reset();
                    axios.get(`https://api.openbd.jp/v1/get?isbn=${this.isbnFull}`).then(response => {
                        if (response.data[0]) {
                            const summary = response.data[0].summary;
                            this.title = summary.title;
                            this.subtitle = response.data[0].onix.DescriptiveDetail.TitleDetail.TitleElement.TitleText.content || "";
                            this.publisherName = summary.publisher;
                            this.pubYear = summary.pubdate.substring(0, 4);
                            this.authorInfo = summary.author;
                        }
                    });
                },
                fetchGoogleBooks: function () {
                    this.reset();
                    axios.get(`https://www.googleapis.com/books/v1/volumes?q=isbn:${this.isbnFull}`).then(response => {
                        if (response.data.items) {
                            const vInfo = response.data.items[0].volumeInfo;
                            this.title = vInfo.title;
                            this.subtitle = vInfo.subtitle || "";
                            this.publisherName = vInfo.publisher || "";
                            this.pubYear = (vInfo.publishedDate || "").substring(0, 4);
                            this.authorInfo = vInfo.authors.join(" ");
                        }
                    })
                },
                googleSearch: function () {
                    window.open("https://www.google.com/search?hl=ja&q=" + this.isbnFull);
                },
                copyFrontMatter: function () {
                    navigator.clipboard.writeText(this.frontMatter);
                    this.frontMatterCopied = true;
                },
                copyFileName: function () {
                    navigator.clipboard.writeText(this.isbnFull);
                    this.fileNameCopied = true;
                },
            },
            watch: {
                bookNum: function () {
                    this.reset();
                    this.frontMatterCopied = false;
                    this.fileNameCopied = false;
                },
                frontMatter: function () {
                    this.frontMatterCopied = false;
                },
            },
        }).mount("#app");
    </script>
</body>

</html>